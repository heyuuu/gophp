<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>GoPhp UI</title>
    <link href="/static/node_modules/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
    <link
            rel="stylesheet"
            data-name="vs/editor/editor.main"
            href="/static/node_modules/monaco-editor/min/vs/editor/editor.main.css"
    />
    <style>
        .changed {
            animation: changed 2s;
        }
        body {
            background-color: gray;
        }

        @keyframes changed {
            from {
                background-color: #FFFF50;
            }
            to {
                background-color: inherit;
            }
        }

        #code-editor {
            height: 100vh;
            border: 1px solid grey;
        }
        #diff-editor {
            height: 100vh;
            border: 1px solid grey;
        }
    </style>
</head>
<body>
<div class="container-fluid" v-scope v-cloak>
    <div class="row" style="margin-top: 10px">
        <div class="col-sm-4">
            <div id="code-editor"></div>
            <div class="card-body">
                <span style="color: red">{{ error }}</span>
            </div>
        </div>
        <div class="col-sm-8">
            <div id="diff-editor" class="card"></div>
        </div>
    </div>
</div>

<script src="/static/node_modules/jquery/dist/jquery.js"></script>
<script src="/static/node_modules/petite-vue/dist/petite-vue.umd.js"></script>
<script src="/static/node_modules/qs/dist/qs.js"></script>
<script src="/static/js/tools.js"></script>

<script>
    var require = {paths: {vs: '/static/node_modules/monaco-editor/min/vs'}};
</script>
<script src="/static/node_modules/monaco-editor/min/vs/loader.js"></script>
<script src="/static/node_modules/monaco-editor/min/vs/editor/editor.main.nls.js"></script>
<script src="/static/node_modules/monaco-editor/min/vs/editor/editor.main.js"></script>

<script>
    // storage
    let initCode = getQueryParam("code") || "<?php\n\n"
    let initShowMode = getQueryParam("mode") || 0b11100
    
    // App
    const apiUri = "/api"
    const app = window.app = {
        code: initCode,
        oldCode: "",
        error: "",
        // 处理结果
        result: [],
        codeChange() {
            this.queryChange()
            this.refresh()
        },
        queryChange() {
            const query = getQuery()
            query.code = this.code
            query.mode = this.showMode
            setQuery(query)
        },
        updateResult(result) {
            this.result = result

            let original = ""
            let modified = ""
            const now = new Date()
            for (const i in result) {
                if (result[i].type === 'Run') {
                    original = result[i].content
                } else if (result[i].type === 'Run-Raw') {
                    modified = result[i].content
                }
            }
            diffEditor.setModel({
                original: monaco.editor.createModel(original, 'text'), 
                modified: monaco.editor.createModel(modified, 'text'),
            })
        },
        refresh(force) {
            if (!force && this.code === this.oldCode) {
                return
            }

            const code = this.code
            postJson(apiUri, {input: code}, (res) => {
                // 确认文本内容没变才更新
                if (this.code !== code) {
                    return
                }

                // 更新数据
                this.oldCode = code
                this.error = res.error
                if (res.code === 0) {
                    this.updateResult(res.data.result)
                }
            }, () => {
                this.error = "请求失败，确认服务是否可用"
            })
        }
    }
    PetiteVue.createApp(app).mount()

    app.refresh()

    // code-editor
    let codeEditor = monaco.editor.create(document.getElementById('code-editor'), {
        value: initCode,
        language: 'php',
        theme: "vs-dark",
    });
    codeEditor.onDidChangeModelContent(function() {
        app.code = codeEditor.getValue()
        app.codeChange()
    })
    setInterval(function () {
        codeEditor.layout()
        diffEditor.layout()
    }, 1000)

    // diff-editor
    let diffEditor = monaco.editor.createDiffEditor(document.getElementById('diff-editor'), {
        theme: "vs-dark",
    })
</script>
</body>
</html>